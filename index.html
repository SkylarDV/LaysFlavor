<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lays Flavor Gallery</title>
	<style>
		:root {
			--bg: #f8f5ec;
			--card: #ffffff;
			--text: #1d1c1a;
			--muted: #5b554f;
			--accent: #ffc800;
		}
		* { box-sizing: border-box; }
		body { margin:0; font-family:"Helvetica Neue", system-ui, -apple-system, "Segoe UI", Arial, sans-serif; background:var(--bg); color:var(--text); }
		header { padding:24px 28px; display:flex; align-items:center; justify-content:space-between; gap:16px; position:sticky; top:0; background:rgba(248,245,236,0.95); backdrop-filter: blur(10px); border-bottom:1px solid rgba(0,0,0,0.06); z-index:10; }
		h1 { margin:0; font-size:22px; letter-spacing:-0.3px; }
		.cta { display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); background:#fff; color:var(--text); text-decoration:none; font-weight:700; }
		.cta:hover { background:#fff7d9; }
		.header-nav { display:flex; align-items:center; gap:12px; }
		#loginBtn { padding:10px 14px; border:none; border-radius:10px; background:var(--accent); color:#000; font-weight:700; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition: all 0.2s ease; }
		#loginBtn:hover { background:#ffb700; transform: translateY(-1px); }
		.login-dropdown { position:relative; display:inline-block; }
		.dropdown-menu { display:none; position:absolute; top:100%; right:0; background:#fff; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.15); min-width:220px; margin-top:8px; overflow:hidden; z-index:50; }
		.dropdown-menu.active { display:block; }
		.dropdown-item { padding:12px 16px; font-size:14px; color:var(--text); border:none; background:none; width:100%; text-align:left; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.06); transition: background 0.15s; text-decoration:none; display:block; }
		.dropdown-item:last-child { border-bottom:none; }
		.dropdown-item:hover { background:#f5f5f5; }
		.dropdown-user { padding:12px 16px; font-size:13px; color:var(--muted); border-bottom:1px solid rgba(0,0,0,0.06); }		#loginForm { padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
		#loginForm input { padding:8px 10px; border:1px solid rgba(0,0,0,0.12); border-radius:6px; font-size:13px; }
		#loginForm button { padding:8px 10px; background:var(--accent); border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:13px; }
		#loginForm button:hover { background:#ffb700; }
		#loginMsg { padding:12px 16px; font-size:12px; color:#b00020; text-align:center; }
		.dropdown-logout { padding:12px 16px; font-size:13px; color:var(--muted); border-bottom:1px solid rgba(0,0,0,0.06); }		#loginForm { padding:16px; display:flex; flex-direction:column; gap:12px; border-bottom:1px solid rgba(0,0,0,0.06); }
		#loginForm input { width:100%; padding:8px 10px; border:1px solid rgba(0,0,0,0.1); border-radius:6px; font-size:13px; }
		#loginForm button { padding:8px 12px; background:var(--accent); border:none; border-radius:6px; font-weight:700; cursor:pointer; font-size:13px; }
		#loginForm button:hover { background:#ffb700; }
		#loginMessage { padding:0 16px; font-size:12px; color:#b00020; display:none; }
		.signup-link { text-align:center; padding:6px 16px 0; font-size:12px; }
		.signup-link a { color:#0066cc; cursor:pointer; font-weight:600; text-decoration:none; }
		.signup-link a:hover { text-decoration:underline; }
		.account-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center; }
		.account-modal.active { display:flex; }
		.account-modal-content { background:#fff; border-radius:12px; padding:32px; max-width:400px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
		.account-modal-title { font-size:22px; font-weight:700; margin-bottom:24px; color:#333; }
		.account-modal-option { margin-bottom:16px; }
		.account-modal-option button { width:100%; padding:12px 16px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; font-size:14px; transition:all 0.2s; }
		.account-modal-option button:hover { background:#f5f5f5; border-color:#999; }
		.account-modal-option button.danger { border-color:#ff4444; color:#ff4444; }
		.account-modal-option button.danger:hover { background:#ffe6e6; }
		.account-modal-close { margin-top:16px; width:100%; padding:8px 16px; border:none; background:none; cursor:pointer; color:var(--muted); font-size:14px; }
		.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:200; }
		.modal-hidden { display:none; }
		.modal-box { background:#fff; border-radius:12px; padding:20px; width:360px; max-width:90vw; box-shadow:0 18px 48px rgba(0,0,0,0.2); position:relative; }
		.modal-box h3 { margin:0 0 10px 0; font-size:18px; }
		.modal-box form { display:flex; flex-direction:column; gap:10px; }
		.modal-box input { width:100%; padding:10px; border:1px solid rgba(0,0,0,0.12); border-radius:8px; font-size:14px; }
		.modal-box button[type="submit"] { background:var(--accent); border:none; border-radius:8px; padding:10px; font-weight:700; cursor:pointer; }
		.modal-box button[type="submit"]:hover { background:#ffb700; }
		.modal-close { position:absolute; top:10px; right:12px; background:none; border:none; font-size:18px; cursor:pointer; }
		#signupMessage { font-size:12px; color:#b00020; min-height:14px; }
		main { padding:20px 24px 40px 24px; max-width:1200px; margin:0 auto; }
		.grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:18px; }
		.card { background:var(--card); border-radius:14px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:10px; min-height:320px; }
		canvas.thumb { width:100%; height:240px; border-radius:10px; background:linear-gradient(135deg, #fdf7de, #fff); }
		.meta { display:flex; flex-direction:column; gap:4px; }
		.name { font-weight:800; font-size:16px; }
		.desc { color:var(--muted); font-size:13px; }
		.load-more { margin:20px auto 0; display:flex; justify-content:center; }
		button#loadMore { padding:10px 16px; border:none; border-radius:10px; background:var(--accent); font-weight:700; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
		button#loadMore:disabled { opacity:0.55; cursor:not-allowed; box-shadow:none; }
		.status { text-align:center; margin:16px 0; color:var(--muted); font-size:13px; }
		.card { position:relative; }
		.like-btn { position:absolute; top:8px; right:8px; width:36px; height:36px; border:none; background:#fff; border-radius:6px; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.12); transition:all 0.2s ease; color:#000; }
		.like-btn:hover { background:#fff; color:#ffc800; transform:scale(1.05); }
		.like-btn.liked { color:#ffc800; }
	</style>
</head>
<body>
	<header>
		<h1>Community Bags</h1>
		<div class="header-nav">
			<a class="cta" href="/configurator.html">Create your own</a>
			<div class="login-dropdown">
				<button id="loginBtn">Login</button>
				<div class="dropdown-menu" id="dropdownMenu">
				<form id="loginForm" style="display:none;">
					<input type="text" id="loginName" placeholder="Username" autocomplete="username" required />
					<input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required />
					<button type="submit">Sign in</button>
					<div class="signup-link"><a href="#" id="openSignup">Don't have an account? Sign up</a></div>
					<div id="loginMessage"></div>
				</form>
				<div id="loggedInView" style="display:none;">
					<a class="dropdown-item" id="profileLink" href="/profile.html">Your Submissions</a>
					<button class="dropdown-item" id="manageAccountBtn">Manage Account</button>
					<button class="dropdown-item" id="logoutBtn">Log out</button>
				</div>
				</div>
			</div>
		</div>
	</header>
	<main>
		<div id="status" class="status">Loading bags…</div>
		<div id="spinner" style="display:none; text-align:center; padding:20px;">
			<div style="width:40px; height:40px; border:4px solid rgba(0,0,0,0.1); border-top-color:#ffc800; border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto;"></div>
		</div>
		<style>
			@keyframes spin { to { transform:rotate(360deg); } }
		</style>
		<div id="grid" class="grid"></div>
		<div class="load-more">
			<button id="loadMore" disabled>Load more</button>
		</div>
	</main>

	<div id="signupModal" class="modal-overlay modal-hidden">
		<div class="modal-box" id="signupBox">
			<button class="modal-close" id="closeSignup" aria-label="Close">×</button>
			<h3>Create an account</h3>
			<form id="signupForm">
				<input type="text" id="signupUsername" placeholder="Username" autocomplete="username" required />
				<input type="email" id="signupEmail" placeholder="Email" autocomplete="email" required />
				<input type="password" id="signupPassword" placeholder="Password" autocomplete="new-password" required />
				<input type="password" id="signupConfirm" placeholder="Confirm password" autocomplete="new-password" required />
				<button type="submit">Sign up</button>
				<div id="signupMessage"></div>
			</form>
		</div>
	</div>
	<script>
		function readStoredUser() {
			try {
				return JSON.parse(localStorage.getItem('laysUser') || 'null');
			} catch (err) {
				localStorage.removeItem('laysUser');
				return null;
			}
		}

		function applyLoginState(user) {
			const loginBtn = document.getElementById('loginBtn');
			const loginForm = document.getElementById('loginForm');
			const loggedInView = document.getElementById('loggedInView');
			const displayName = user && (user.name || user.username);

			if (displayName) {
				loginBtn.textContent = `Logged in as ${displayName}`;
				if (loginForm) loginForm.style.display = 'none';
				if (loggedInView) loggedInView.style.display = 'block';
			} else {
				loginBtn.textContent = 'Login';
				if (loginForm) loginForm.style.display = 'flex';
				if (loggedInView) loggedInView.style.display = 'none';
			}
		}

		function updateLoginUI() {
			applyLoginState(readStoredUser());
		}

		// Toggle dropdown menu
		document.getElementById('loginBtn').addEventListener('click', (e) => {
			e.stopPropagation();
			const dropdownMenu = document.getElementById('dropdownMenu');
			updateLoginUI();
			dropdownMenu.classList.toggle('active');
		});

		// Logout
		document.getElementById('logoutBtn').addEventListener('click', () => {
			localStorage.removeItem('laysUser');
			document.getElementById('dropdownMenu').classList.remove('active');
			updateLoginUI();
		});

		function decodeJWT(token) {
			try {
				const parts = token.split('.');
				if (parts.length !== 3) return null;
				const decoded = JSON.parse(atob(parts[1]));
				return decoded;
			} catch (err) {
				return null;
			}
		}

		// Login form submission
		document.getElementById('loginForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const username = document.getElementById('loginName').value.trim();
			const password = document.getElementById('loginPassword').value.trim();
			const loginMsg = document.getElementById('loginMessage');
			
			loginMsg.textContent = 'Signing in...';
			loginMsg.style.display = 'block';
			loginMsg.style.color = '#1d1c1a';
			
			try {
				const res = await fetch('https://laysflavorapi.onrender.com/api/user/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username, password })
				});
				const data = await res.json().catch(() => null);
				
				if (!res.ok) {
					const message = (data && (data.message || data.error)) || 'Login failed';
					throw new Error(message);
				}
				
				// Extract token from data.data.token or fallback paths
				const token = data?.data?.token || data?.token || data?.jwt || data?.accessToken || data?.access_token || null;
				const userName = (data && (data.username || data.name || data.user?.username || data.user?.name)) || username;
				let userId = (data && (data.user?._id || data.user?.id || data._id || data.id)) || null;
				
				// If no userId but have token, decode JWT to extract _id
				if (!userId && token) {
					const decoded = decodeJWT(token);
					userId = decoded?._id || decoded?.id || null;

				}
				
				console.log('Login - token:', !!token, 'userId:', userId, 'userName:', userName);
				
				const user = { name: userName, token: token || null, id: userId || null };
				
				localStorage.setItem('laysUser', JSON.stringify(user));
			
				loginMsg.textContent = 'Login successful!';
				loginMsg.style.color = '#22bb33';
				loginMsg.style.display = 'block';
			
				document.getElementById('loginForm').reset();
				document.getElementById('dropdownMenu').classList.remove('active');
				updateLoginUI();
				
				setTimeout(() => { loginMsg.style.display = 'none'; }, 1500);
			} catch (err) {
				loginMsg.textContent = 'Error: ' + err.message;
				loginMsg.style.color = '#b00020';
				loginMsg.style.display = 'block';
			}
		});

		// Open signup modal
		document.getElementById('openSignup').addEventListener('click', (e) => {
			e.preventDefault();
			e.stopPropagation();
			document.getElementById('dropdownMenu').classList.remove('active');
			document.getElementById('signupModal').classList.remove('modal-hidden');
		});

		// Close signup modal helpers
		function closeSignupModal() {
			document.getElementById('signupForm').reset();
			document.getElementById('signupMessage').textContent = '';
			document.getElementById('signupModal').classList.add('modal-hidden');
		}

		document.getElementById('closeSignup').addEventListener('click', (e) => {
			e.stopPropagation();
			closeSignupModal();
		});

		document.getElementById('signupModal').addEventListener('click', () => {
			closeSignupModal();
		});

		document.getElementById('signupBox').addEventListener('click', (e) => {
			e.stopPropagation();
		});

		// Signup form submission
		document.getElementById('signupForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const username = document.getElementById('signupUsername').value.trim();
			const email = document.getElementById('signupEmail').value.trim();
			const password = document.getElementById('signupPassword').value;
			const confirm = document.getElementById('signupConfirm').value;
			const msg = document.getElementById('signupMessage');

			if (password !== confirm) {
				msg.textContent = 'Passwords do not match';
				msg.style.color = '#b00020';
				return;
			}

			msg.textContent = 'Creating account...';
			msg.style.color = '#1d1c1a';

			try {
				const res = await fetch('https://laysflavorapi.onrender.com/api/user/signup', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ username, email, password })
				});
				const data = await res.json();

				if (data.status === 'success') {
					msg.textContent = 'Account created! Please sign in.';
					msg.style.color = '#22bb33';
					setTimeout(() => {
						closeSignupModal();
						// reopen login dropdown to let user sign in
						document.getElementById('dropdownMenu').classList.add('active');
					}, 600);
				} else {
					msg.textContent = data.message || 'Signup failed';
					msg.style.color = '#b00020';
				}
			} catch (err) {
				msg.textContent = 'Error: ' + err.message;
				msg.style.color = '#b00020';
			}
		});

		// Prevent dropdown from closing when clicking inside it
		document.getElementById('dropdownMenu').addEventListener('click', (e) => {
			e.stopPropagation();
		});

		// Close dropdown when clicking outside
		document.addEventListener('click', () => {
			document.getElementById('dropdownMenu').classList.remove('active');
		});

		window.addEventListener('storage', updateLoginUI);

		// Initialize on load
		updateLoginUI();

		// Manage Account Modal
		const accountModal = document.createElement('div');
		accountModal.className = 'account-modal';
		accountModal.id = 'accountModal';
		accountModal.innerHTML = `
			<div class="account-modal-content">
				<div class="account-modal-title">Manage Account</div>
				<div id="accountModalBody">
					<div class="account-modal-option">
						<button id="changePasswordBtn">Change Password</button>
					</div>
					<div class="account-modal-option">
						<button id="deleteAccountBtn" class="danger">Delete Account</button>
					</div>
				</div>
				<div id="changePasswordForm" style="display:none;">
					<div style="margin-bottom:16px;">
						<label style="display:block; margin-bottom:6px; font-size:14px; font-weight:600;">Current Password</label>
						<input type="password" id="currentPassword" placeholder="Enter current password" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
					</div>
					<div style="margin-bottom:16px;">
						<label style="display:block; margin-bottom:6px; font-size:14px; font-weight:600;">New Password</label>
						<input type="password" id="newPassword" placeholder="Enter new password" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
					</div>
					<div style="margin-bottom:16px;">
						<label style="display:block; margin-bottom:6px; font-size:14px; font-weight:600;">Confirm Password</label>
						<input type="password" id="confirmPassword" placeholder="Confirm new password" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
					</div>
					<div id="passwordMessage" style="margin-bottom:16px; font-size:13px; color:#b00020; min-height:20px;"></div>
					<button id="submitPasswordBtn" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:6px; font-weight:700; cursor:pointer; margin-bottom:8px;">Change Password</button>
					<button id="backToMenuBtn" style="width:100%; padding:8px; background:none; border:1px solid #ddd; border-radius:6px; cursor:pointer; font-size:14px;">Back</button>
				</div>
				<button class="account-modal-close" id="closeAccountModal">Close</button>
			</div>
		`;
		document.body.appendChild(accountModal);

		// Open manage account modal
		document.getElementById('manageAccountBtn').addEventListener('click', (e) => {
			e.stopPropagation();
			document.getElementById('dropdownMenu').classList.remove('active');
			document.getElementById('accountModal').classList.add('active');
		});

		// Close account modal
		document.getElementById('closeAccountModal').addEventListener('click', () => {
			document.getElementById('accountModal').classList.remove('active');
		});

		// Click outside modal to close
		document.getElementById('accountModal').addEventListener('click', (e) => {
			if (e.target.id === 'accountModal') {
				document.getElementById('accountModal').classList.remove('active');
			}
		});

		// Change password button
		document.getElementById('changePasswordBtn').addEventListener('click', () => {
			document.getElementById('accountModalBody').style.display = 'none';
			document.getElementById('changePasswordForm').style.display = 'block';
		});

		// Back button
		document.getElementById('backToMenuBtn').addEventListener('click', () => {
			document.getElementById('changePasswordForm').style.display = 'none';
			document.getElementById('accountModalBody').style.display = 'block';
			document.getElementById('currentPassword').value = '';
			document.getElementById('newPassword').value = '';
			document.getElementById('confirmPassword').value = '';
			document.getElementById('passwordMessage').textContent = '';
		});

		// Submit password change
		document.getElementById('submitPasswordBtn').addEventListener('click', async () => {
			const currentPassword = document.getElementById('currentPassword').value;
			const newPassword = document.getElementById('newPassword').value;
			const confirmPassword = document.getElementById('confirmPassword').value;
			const messageEl = document.getElementById('passwordMessage');

			if (!currentPassword || !newPassword || !confirmPassword) {
				messageEl.textContent = 'All fields are required';
				messageEl.style.color = '#b00020';
				return;
			}

			if (newPassword !== confirmPassword) {
				messageEl.textContent = 'Passwords do not match';
				messageEl.style.color = '#b00020';
				return;
			}

			try {
				const user = JSON.parse(localStorage.getItem('laysUser'));
				const res = await fetch('https://laysflavorapi.onrender.com/api/user/change-password', {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${user.token}`
					},
					body: JSON.stringify({ oldPassword: currentPassword, newPassword })
				});
				const data = await res.json();

				if (data.status === 'success') {
					messageEl.textContent = 'Password changed successfully!';
					messageEl.style.color = '#22bb33';
					setTimeout(() => {
						document.getElementById('changePasswordForm').style.display = 'none';
						document.getElementById('accountModalBody').style.display = 'block';
						document.getElementById('currentPassword').value = '';
						document.getElementById('newPassword').value = '';
						document.getElementById('confirmPassword').value = '';
						document.getElementById('passwordMessage').textContent = '';
					}, 1500);
				} else {
					messageEl.textContent = data.message || 'Failed to change password';
					messageEl.style.color = '#b00020';
				}
			} catch (err) {
				messageEl.textContent = 'Error: ' + err.message;
				messageEl.style.color = '#b00020';
			}
		});

		// Delete account
		document.getElementById('deleteAccountBtn').addEventListener('click', () => {
			if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
			if (!confirm('This will permanently delete your account and all your bags. Continue?')) return;

			const user = JSON.parse(localStorage.getItem('laysUser'));
			fetch(`https://laysflavorapi.onrender.com/api/user/${user.id}`, {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${user.token}`
				}
			})
			.then(res => res.json())
			.then(data => {
				if (data.status === 'success') {
					localStorage.removeItem('laysUser');
					alert('Account deleted successfully');
					window.location.href = '/';
				} else {
					alert(data.message || 'Failed to delete account');
				}
			})
			.catch(err => alert('Error: ' + err.message));
		});
	</script>
	<script type="module" src="/list.js"></script>
</body>
</html>
